## -*- mode: makefile -*-

## @configure_input@

## 
## This file is part of the Score-P software (http://www.score-p.org)
##
## Copyright (c) 2009-2012, 
##    RWTH Aachen, Germany
##    Gesellschaft fuer numerische Simulation mbH Braunschweig, Germany
##    Technische Universitaet Dresden, Germany
##    University of Oregon, Eugene, USA
##    Forschungszentrum Juelich GmbH, Germany
##    German Research School for Simulation Sciences GmbH, Juelich/Aachen, Germany
##    Technische Universitaet Muenchen, Germany
##
## See the COPYING file in the package base directory for details.
##

## file       test/installcheck/Makefile.common.in
## maintainer Christian Roessel <c.roessel@fz-juelich.de>

all:

#------------------------------------------------------------------------------
# Common settings
#------------------------------------------------------------------------------

BINDIR          = @abs_top_builddir@/../installcheck/bin
INCDIR          = @abs_top_builddir@/../installcheck
PARADIGM_SRCDIR = @abs_top_srcdir@/../test/installcheck/$(PARADIGM)/src
PREPS_FILE      = @abs_top_builddir@/../installcheck/configurations_$(PARADIGM)

@SCOREP_COMPILER_SUN_TRUE@SKIP_DEFAULT = yes
@SCOREP_COMPILER_SUN_FALSE@SKIP_DEFAULT = no

#------------------------------------------------------------------------------
# Instrument possible configurations: 
# If we have a Makefile in PARADIGM_SRCDIR/<code>/<language>, create
# an object directory (obj_dir) for every possible scorep option
# configuration, copy the Makefile into this directory an call 'make
# -C obj_dir <code>' additionally providing several make
# variables. The possible configurations are listed in PREPS_FILE and
# are generated from
# scorep_configure_dir/installcheck/instrumenter-configurations.sh. Instrumented
# codes can be found in BINDIR.
#------------------------------------------------------------------------------
instrument-configurations: $(PREPS_FILE) $(PARADIGM_SRCDIR) $(BINDIR)
	@for code in $(CODES); do \
            for language in $(LANGUAGES); do \
                if test -e $(PARADIGM_SRCDIR)/$$code/$$language/Makefile; then \
                    if test "x$(SKIP_DEFAULT)" = "xno"; then \
                        suffix="_default"; \
                        obj_dir="`pwd`/build/$$code/$$language/$$suffix"; \
                        mkdir -p "$$obj_dir"; \
                        cp $(PARADIGM_SRCDIR)/$$code/$$language/Makefile "$$obj_dir"/; \
                        echo "  GEN    ../installcheck/bin/$${code}-$(PARADIGM)-$${language}$${suffix}"; \
                        $(MAKE) -C $$obj_dir \
                            PREP="@prefix@/bin/scorep" \
                            SUFFIX="$$suffix" \
                            OBJDIR="$$obj_dir" \
                            BINDIR="$(BINDIR)" \
                            CODE="$$code" \
                            LANG="$$language" \
                            SRCDIR="$(PARADIGM_SRCDIR)/$$code/$$language" \
                            INCDIR="$(INCDIR)" \
                            PARADIGM="$(PARADIGM)" \
                            CC="$(CC)" \
                            CXX="$(CXX)" \
                            F77="$(F77)" \
                            FC="$(FC)" \
                            CFLAGS="$(CFLAGS)" \
                            CXXFLAGS="$(CXXFLAGS)" \
                            F77FLAGS="$(F77FLAGS)" \
                            FCFLAGS="$(FCFLAGS)" \
                            $$code || exit 1; \
                    fi; \
                    while read line; do \
                        prep=`echo $$line | awk '{for (i=1; i<= NF; i++) {options = options " --" $$i} } END{print "@prefix@/bin/scorep" options}'`; \
                        suffix=`echo $$line | awk '{for (i=1; i<= NF; i++) {suffix = suffix "_" $$i} } END{print suffix}'`; \
                        obj_dir="`pwd`/build/$$code/$$language/$$suffix"; \
                        mkdir -p "$$obj_dir"; \
                        cp $(PARADIGM_SRCDIR)/$$code/$$language/Makefile "$$obj_dir"/; \
                        echo "  GEN    ../installcheck/bin/$${code}-$(PARADIGM)-$${language}$${suffix}"; \
                        $(MAKE) -C $$obj_dir \
                            PREP="@prefix@/bin/scorep" \
                            SUFFIX="$$suffix" \
                            OBJDIR="$$obj_dir" \
                            BINDIR="$(BINDIR)" \
                            CODE="$$code" \
                            LANG="$$language" \
                            SRCDIR="$(PARADIGM_SRCDIR)/$$code/$$language" \
                            INCDIR="$(INCDIR)" \
                            PARADIGM="$(PARADIGM)" \
                            CC="$(CC)" \
                            CXX="$(CXX)" \
                            F77="$(F77)" \
                            FC="$(FC)" \
                            CFLAGS="$(CFLAGS)" \
                            CXXFLAGS="$(CXXFLAGS)" \
                            F77FLAGS="$(F77FLAGS)" \
                            FCFLAGS="$(FCFLAGS)" \
                            $$code || exit 1; \
                    done < $(PREPS_FILE); \
                fi; \
            done; \
        done

$(BINDIR):
	mkdir -p $(BINDIR)

$(PREPS_FILE):
	$(MAKE) -C @abs_top_builddir@ instrumenter-configurations
